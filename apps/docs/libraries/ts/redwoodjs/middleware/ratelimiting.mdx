---
title: "Rate limiting"
description: "Unkey Rate limiting with RedwoodJS Middleware"
---

# Usage

Rate limit requests using `withUnkey` middleware.

<Note>Middleware is only available when SSR is enabled in RedwoodJS.</Note>

## Unkey Setup

See [Rate limiting Onboarding](https://www.unkey.com/docs/onboarding/onboarding-ratelimiting) to get started with standalone [rate limiting](https://www.unkey.com/docs/apis/features/ratelimiting) from [Unkey](https://www.unkey.com).

Note: Be sure to set your `UNKEY_ROOT_KEY` or key to be used for rate limiting in an `.env` file.

## Examples

`withUnkey` provides several ways to customize rate limiting for a variety of use cases.

The following examples sow how to set:

- pattern matches when registering the middleware to match paths on which to enforce rate limits
- custom identifier generator function
- custom rate limit exceeded responses
- custom error responses

### Rate Limit All Requests

To rate limit all requests, register the unkeyMiddleware without route matching.

```ts file="web/src/entry.server.tsx"
import withUnkey from "@unkey/redwoodjs";
import type { withUnkeyOptions } from "@unkey/redwoodjs";

export const registerMiddleware = () => {
  const options: withUnkeyOptions = {
    ratelimitConfig: {
      rootKey: process.env.UNKEY_ROOT_KEY,
      namespace: "my-app",
      limit: 1,
      duration: "30s",
      async: true,
    },
  };

  const unkeyMiddleware = withUnkey(options);

  return [unkeyMiddleware];
};
```

### Basic Matching

To rate limit a matching rout, register the unkeyMiddleware with the matching pattern.

```ts file="web/src/entry.server.tsx"
import withUnkey from "@unkey/redwoodjs";
import type { withUnkeyOptions } from "@unkey/redwoodjs";

export const registerMiddleware = () => {
  const options: withUnkeyOptions = {
    ratelimitConfig: {
      rootKey: process.env.UNKEY_ROOT_KEY,
      namespace: "my-app",
      limit: 1,
      duration: "30s",
      async: true,
    },
  };

  const unkeyMiddleware = withUnkey(options);

  return [[unkeyMiddleware, "/blog-post/:slug(\\d{1,})"]];
};
```

Note: If you need to match multiple patterns you can compose a complex expression

```ts
return [[unkeyMiddleware, "/rss.(xml|atom|json)"]];
```

or register multiple with different patterns:

```ts
return [
  [unkeyMiddleware, "/blog-post/:slug(\\d{1,})"],
  [unkeyMiddleware, "/admin"],
];
```

### With Custom Identifier Function and Third Party Authentication

Here, we use a custom identifier function `supabaseRatelimitIdentifier` that:

- checks is the request is authenticated
- constructs the identifier `sub` from the current user, since here the currentUser will be a JWT where the user id is the `sub` claim
- registers `supabaseAuthMiddleware` before `unkeyMiddleware` so the request can be authenticated before determining limits

```ts file="web/src/entry.server.ts"
import createSupabaseAuthMiddleware from "@redwoodjs/auth-supabase-middleware";
import withUnkey from "@unkey/redwoodjs";
import type { withUnkeyOptions } from "@unkey/redwoodjs";
import type { MiddlewareRequest } from "@redwoodjs/vite/middleware";
import type { TagDescriptor } from "@redwoodjs/web";

import App from "./App";
import { Document } from "./Document";

// eslint-disable-next-line no-restricted-imports
import { getCurrentUser } from "$api/src/lib/auth";

interface Props {
  css: string[];
  meta?: TagDescriptor[];
}

export const supabaseRatelimitIdentifier = (req: MiddlewareRequest) => {
  const authContext = req?.serverAuthContext?.get();
  console.log(">>>> in supabaseRatelimitIdentifier", authContext);
  const identifier = authContext?.isAuthenticated
    ? (authContext.currentUser?.sub as string) || "anonymous-user"
    : "192.168.1.1";
  return identifier;
};

export const registerMiddleware = () => {
  const options: withUnkeyOptions = {
    ratelimitConfig: {
      rootKey: process.env.UNKEY_ROOT_KEY,
      namespace: "my-app",
      limit: 1,
      duration: "30s",
      async: true,
    },
    ratelimitIdentifierFn: supabaseRatelimitIdentifier,
  };
  const unkeyMiddleware = withUnkey(options);
  const supabaseAuthMiddleware = createSupabaseAuthMiddleware({
    getCurrentUser,
  });

  return [
    supabaseAuthMiddleware,
    [unkeyMiddleware, "/blog-post/:slug(\\d{1,})"],
  ];
};
```

## Custom Rate Limit Exceeded Response

```ts
export const registerMiddleware = () => {
  const options: withUnkeyOptions = {
    ratelimitConfig: {
      rootKey: process.env.UNKEY_ROOT_KEY,
      namespace: "my-app",
      limit: 1,
      duration: "30s",
      async: true,
    },
    ratelimitExceededResponseFn: (_req: MiddlewareRequest) => {
      return new MiddlewareResponse("Custom Rate limit exceeded message", {
        status: 429,
      });
    },
  };
  const unkeyMiddleware = withUnkey(options);

  return [unkeyMiddleware];
};
```

## Custom Rate Limit Error Response

```ts
export const registerMiddleware = () => {
  const options: withUnkeyOptions = {
    ratelimitConfig: {
      rootKey: process.env.UNKEY_ROOT_KEY,
      namespace: "my-app",
      limit: 1,
      duration: "30s",
      async: true,
    },
    matcher: ["/blog-post/:slug(\\d{1,})"],
    ratelimitErrorResponseFn: (_req: MiddlewareRequest) => {
      return new MiddlewareResponse("Custom Error message when rate limiting", {
        status: 500,
      });
    },
  };
  const unkeyMiddleware = withUnkey(options);

  return [unkeyMiddleware];
};
```
