import { createLogger } from "@redwoodjs/api/logger";
import { MiddlewareRequest, MiddlewareResponse } from "@redwoodjs/vite/middleware";
import { Ratelimit } from "@unkey/ratelimit";
import type { RatelimitConfig, RatelimitResponse } from "@unkey/ratelimit";
import { assert, describe, expect, it, vi } from "vitest";
import withUnkey from "../index";
import type { withUnkeyOptions } from "../index";

/**
 * Mock the Ratelimit class
 *
 * Use namespace to store the ratelimit identifier that determines if the rate limit is exceeded
 *
 * If namespace matches the identifier generated by withUnkey middleware, the rate limit is exceeded
 * and the response status is 429 because success is false
 */
vi.mock("@unkey/ratelimit", () => {
  let rateLimitIdentifier = "";

  return {
    Ratelimit: class {
      constructor(config: RatelimitConfig) {
        rateLimitIdentifier = config.namespace;
      }
      limit(identifier: string): Promise<RatelimitResponse> {
        return Promise.resolve({
          success: identifier === rateLimitIdentifier,
          limit: 0,
          remaining: 0,
          reset: 0,
        });
      }
    },
  };
});

const MOCK_ROOT_KEY = "unkey_mocked_root_key";

const defaultRateLimitConfig: Pick<RatelimitConfig, "rootKey" | "limit" | "duration" | "async"> = {
  rootKey: MOCK_ROOT_KEY,
  limit: 1,
  duration: "30s",
  async: true,
};

describe("withUnkey", () => {
  it("should pass response through as path does not match", async () => {
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "192.168.1.1",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/user"],
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/no/match");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse("PASS THROUGH OK", { status: 200 });
    const result = await unkeyMiddleware(req, res);
    expect(result.status).toBe(200);
    expect(result.body).toBe("PASS THROUGH OK");
  });

  it("should work", async () => {
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "192.168.1.1",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/user"],
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/user");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);
    expect(result.status).toBe(200);
  });

  it("should be limited", async () => {
    // here the namespace will cause the rate limit to be exceeded because it does not match the identifier
    // generated by the withUnkey middleware
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "my-app",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/user"],
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/user");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);
    expect(result.status).toBe(429);
  });

  it("should be limited when matches one of provided matcher patterns", async () => {
    // here the namespace will cause the rate limit to be exceeded because it does not match the identifier
    // generated by the withUnkey middleware
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "my-app",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/no-match", "/api/it-matches"],
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/it-matches");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);
    expect(result.status).toBe(429);
  });

  it("should be not limited with a custom default identifier function", async () => {
    // here the namespace will cause the rate limit to be exceeded because it does not match the identifier
    // generated by the withUnkey middleware
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "abcdefg",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/user"],
      ratelimitIdentifierFn: (_req: MiddlewareRequest) => {
        return "abcdefg";
      },
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/user");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);
    expect(result.status).toBe(200);
  });

  it("should be limited with a custom default identifier function", async () => {
    // here the namespace will cause the rate limit to be exceeded because it does not match the identifier
    // generated by the withUnkey middleware
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "12345",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/user"],
      ratelimitIdentifierFn: (_req: MiddlewareRequest) => {
        return "abcdefg";
      },
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/user");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);
    expect(result.status).toBe(429);
  });

  it("should be limited with a custom rate limit exceeded message function", async () => {
    // here the namespace will cause the rate limit to be exceeded because it does not match the identifier
    // generated by the withUnkey middleware
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "exceeded",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/user"],
      ratelimitExceededResponseFn: (_req: MiddlewareRequest) => {
        return new MiddlewareResponse("Custom Rate limit exceeded message", {
          status: 429,
        });
      },
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/user");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);
    expect(result.status).toBe(429);
    expect(result.body).toBe("Custom Rate limit exceeded message");
  });

  it("should error", async () => {
    // here the namespace will cause the rate limit to be exceeded because it does not match the identifier
    // generated by the withUnkey middleware
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "exceeded",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/user"],
      ratelimitIdentifierFn: (_req: MiddlewareRequest) => {
        throw new Error("Error simulated by test");
      },
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/user");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);

    expect(result.body).toBe("Internal server error");
    expect(result.status).toBe(500);
  });

  it("should error with custom message", async () => {
    // here the namespace will cause the rate limit to be exceeded because it does not match the identifier
    // generated by the withUnkey middleware
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "exceeded",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/user"],
      ratelimitIdentifierFn: (_req: MiddlewareRequest) => {
        throw new Error("Error simulated by test");
      },
      ratelimitErrorResponseFn: (_req: MiddlewareRequest) => {
        return new MiddlewareResponse("Custom Error message when rate limiting", {
          status: 500,
        });
      },
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/user");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);

    expect(result.body).toBe("Custom Error message when rate limiting");
    expect(result.status).toBe(500);
  });

  it("should error with custom message and status", async () => {
    // here the namespace will cause the rate limit to be exceeded because it does not match the identifier
    // generated by the withUnkey middleware
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "exceeded",
        ...defaultRateLimitConfig,
      },
      matcher: ["/api/user"],
      ratelimitIdentifierFn: (_req: MiddlewareRequest) => {
        throw new Error("Error simulated by test");
      },
      ratelimitErrorResponseFn: (_req: MiddlewareRequest) => {
        return new MiddlewareResponse("Not implemented", {
          status: 501,
        });
      },
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/user");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);

    expect(result.body).toBe("Not implemented");
    expect(result.status).toBe(501);
  });

  it("should use a RedwoodJS-compatible logger", async () => {
    // here the namespace will cause the rate limit to be exceeded because it does not match the identifier
    // generated by the withUnkey middleware
    const options: withUnkeyOptions = {
      ratelimitConfig: {
        namespace: "exceeded",
        ...defaultRateLimitConfig,
      },
      logger: createLogger({
        options: { level: "error", enabled: true },
      }),

      matcher: ["/api/user"],
      ratelimitIdentifierFn: (_req: MiddlewareRequest) => {
        throw new Error("Error simulated by test");
      },
      ratelimitErrorResponseFn: (_req: MiddlewareRequest) => {
        return new MiddlewareResponse("Not implemented", {
          status: 501,
        });
      },
    };
    const unkeyMiddleware = withUnkey(options);
    const request = new Request("http://localhost:8910/api/user");
    const req = new MiddlewareRequest(request);
    const res = new MiddlewareResponse();
    const result = await unkeyMiddleware(req, res);

    expect(result.body).toBe("Not implemented");
    expect(result.status).toBe(501);
  });
});
